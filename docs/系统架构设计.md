# 🏗️ 系统架构设计

**项目：** MOMO炒饭店小说网站 V2.0  
**架构师：** 工程师A  
**设计日期：** 2025-10-27  
**版本：** v1.0

---

## 📋 目录

1. [架构概览](#架构概览)
2. [技术栈](#技术栈)
3. [系统分层](#系统分层)
4. [数据库设计](#数据库设计)
5. [接口设计](#接口设计)
6. [安全架构](#安全架构)
7. [性能优化](#性能优化)
8. [部署架构](#部署架构)

---

## 🎯 架构概览

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                      用户浏览器                           │
│                 (Chrome/Safari/Firefox)                 │
└────────────────────┬────────────────────────────────────┘
                     │
                     │ HTTPS
                     ▼
┌─────────────────────────────────────────────────────────┐
│                      Nginx反向代理                        │
│                  (负载均衡 + SSL终结)                      │
└────────┬──────────────────────────────────┬─────────────┘
         │                                  │
         │ 静态资源                          │ API请求
         ▼                                  ▼
┌──────────────────┐              ┌──────────────────────┐
│   前端应用         │              │     后端API服务       │
│   Vue 3 + Vite   │              │  Fastify + Node.js   │
│   Port: 5188     │              │     Port: 3000       │
└──────────────────┘              └──────────┬───────────┘
                                             │
                    ┌────────────────────────┼──────────────┐
                    │                        │              │
                    ▼                        ▼              ▼
          ┌──────────────────┐    ┌──────────────┐  ┌────────────┐
          │   MySQL 8.0      │    │   Redis 7.0  │  │  文件存储   │
          │   (主数据库)      │    │   (缓存)     │  │  (本地/OSS) │
          └──────────────────┘    └──────────────┘  └────────────┘
```

---

### 核心设计原则

```
1. 🔄 前后端分离
   - 前端：Vue 3 SPA
   - 后端：RESTful API
   - 通信：JSON格式

2. 📦 模块化设计
   - 按功能模块划分
   - 低耦合，高内聚
   - 易于维护和扩展

3. 🔒 安全第一
   - JWT身份认证
   - 数据加密传输
   - 输入验证
   - SQL注入防护

4. ⚡ 性能优化
   - Redis缓存
   - 数据库索引
   - CDN加速
   - 懒加载

5. 📈 可扩展性
   - 微服务预留
   - 水平扩展支持
   - 数据库分库分表准备
```

---

## 🛠️ 技术栈

### 前端技术栈

```yaml
核心框架:
  - Vue 3.4+          # 渐进式框架
  - TypeScript 5.3+   # 类型安全

构建工具:
  - Vite 5.0+         # 快速构建

UI框架:
  - Element Plus      # 组件库
  - Tailwind CSS 3.4+ # 原子化CSS

状态管理:
  - Pinia 2.1+        # 轻量状态管理

路由:
  - Vue Router 4.2+   # 官方路由

工具库:
  - Axios             # HTTP客户端
  - VueUse            # 组合式工具库
  - DayJS             # 日期处理
  - DOMPurify         # XSS防护
```

---

### 后端技术栈

```yaml
核心框架:
  - Node.js 18+       # 运行时
  - Fastify 4.25+     # Web框架
  - TypeScript 5.3+   # 类型安全

数据库:
  - MySQL 8.0         # 关系数据库
  - Prisma 5.9+       # ORM
  - Redis 7.0         # 缓存

认证:
  - JWT               # Token认证
  - bcrypt            # 密码加密

工具库:
  - Zod               # 数据验证
  - DayJS             # 日期处理
  - dotenv            # 环境变量
```

---

### 开发工具

```yaml
版本控制:
  - Git               # 版本管理
  - GitHub/Gitee      # 代码托管

开发环境:
  - VS Code           # IDE
  - Prisma Studio     # 数据库管理

测试:
  - Vitest            # 单元测试
  - Playwright        # E2E测试

代码质量:
  - ESLint            # 代码检查
  - Prettier          # 代码格式化
  - TypeScript        # 类型检查
```

---

## 📚 系统分层

### 前端分层架构

```
frontend/
├── src/
│   ├── views/              # 页面视图层
│   │   ├── Home.vue
│   │   ├── Novel/
│   │   │   ├── List.vue
│   │   │   ├── Detail.vue
│   │   │   └── Edit.vue
│   │   └── User/
│   │       ├── Profile.vue
│   │       └── Settings.vue
│   │
│   ├── components/         # 组件层
│   │   ├── common/         # 公共组件
│   │   │   ├── Button.vue
│   │   │   ├── Input.vue
│   │   │   └── Modal.vue
│   │   └── business/       # 业务组件
│   │       ├── NovelCard.vue
│   │       ├── CommentList.vue
│   │       └── UserAvatar.vue
│   │
│   ├── composables/        # 组合式函数（业务逻辑）
│   │   ├── useAuth.ts
│   │   ├── useNovel.ts
│   │   └── useComment.ts
│   │
│   ├── stores/             # 状态管理
│   │   ├── auth.ts
│   │   ├── novel.ts
│   │   └── user.ts
│   │
│   ├── api/                # API接口层
│   │   ├── auth.ts
│   │   ├── novel.ts
│   │   └── user.ts
│   │
│   ├── utils/              # 工具函数
│   │   ├── request.ts      # 请求封装
│   │   ├── format.ts       # 格式化
│   │   └── validate.ts     # 验证
│   │
│   ├── types/              # TypeScript类型
│   │   ├── api.d.ts
│   │   ├── novel.d.ts
│   │   └── user.d.ts
│   │
│   ├── router/             # 路由配置
│   │   └── index.ts
│   │
│   └── assets/             # 静态资源
│       ├── styles/
│       └── images/
```

---

### 后端分层架构

```
backend/
├── src/
│   ├── routes/             # 路由层（URL映射）
│   │   ├── auth.routes.ts
│   │   ├── novel.routes.ts
│   │   └── user.routes.ts
│   │
│   ├── controllers/        # 控制器层（请求处理）
│   │   ├── auth.controller.ts
│   │   ├── novel.controller.ts
│   │   └── user.controller.ts
│   │
│   ├── services/           # 服务层（业务逻辑）
│   │   ├── auth.service.ts
│   │   ├── novel.service.ts
│   │   └── user.service.ts
│   │
│   ├── repositories/       # 数据访问层（可选）
│   │   ├── novel.repository.ts
│   │   └── user.repository.ts
│   │
│   ├── middlewares/        # 中间件
│   │   ├── auth.middleware.ts
│   │   ├── error.middleware.ts
│   │   └── logger.middleware.ts
│   │
│   ├── utils/              # 工具函数
│   │   ├── jwt.ts
│   │   ├── password.ts
│   │   └── validator.ts
│   │
│   ├── types/              # TypeScript类型
│   │   ├── api.d.ts
│   │   └── models.d.ts
│   │
│   ├── config/             # 配置文件
│   │   ├── database.ts
│   │   └── redis.ts
│   │
│   └── server.ts           # 入口文件
│
├── prisma/
│   └── schema.prisma       # 数据库模型
│
└── tests/                  # 测试文件
    ├── unit/
    └── integration/
```

---

### 请求处理流程

```
1. 用户请求
   ↓
2. Nginx接收（反向代理）
   ↓
3. 路由层（Routes）匹配路由
   ↓
4. 中间件层（Middlewares）
   - 日志记录
   - 身份认证
   - 权限检查
   ↓
5. 控制器层（Controllers）处理请求
   - 参数验证
   - 调用服务层
   ↓
6. 服务层（Services）业务逻辑
   - 数据处理
   - 缓存查询
   - 数据库操作
   ↓
7. 数据库层（Prisma + MySQL）
   ↓
8. 返回响应
   ↓
9. 用户接收
```

---

## 🗄️ 数据库设计

### ER图

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│    User     │         │    Novel     │         │   Comment   │
├─────────────┤         ├──────────────┤         ├─────────────┤
│ id          │────┐    │ id           │────┐    │ id          │
│ username    │    │    │ title        │    │    │ content     │
│ email       │    │    │ summary      │    │    │ novelId     │─┐
│ password    │    │    │ content      │    │    │ userId      │─┼─┐
│ avatar      │    └───<│ authorId     │    └───<│ createdAt   │ │ │
│ createdAt   │         │ category     │         └─────────────┘ │ │
└─────────────┘         │ views        │                         │ │
                        │ likes        │                         │ │
      ┌─────────────────│ favorites    │                         │ │
      │                 │ status       │                         │ │
      │                 │ createdAt    │                         │ │
      │                 └──────────────┘                         │ │
      │                                                          │ │
      │                 ┌──────────────┐                         │ │
      │                 │     Like     │                         │ │
      │                 ├──────────────┤                         │ │
      │                 │ id           │                         │ │
      │            ┌───<│ novelId      │<────────────────────────┘ │
      │            │    │ userId       │<──────────────────────────┘
      │            │    │ createdAt    │
      │            │    └──────────────┘
      │            │
      │            │    ┌──────────────┐
      │            │    │   Favorite   │
      │            │    ├──────────────┤
      │            │    │ id           │
      │            └───<│ novelId      │
      │                 │ userId       │<──────────┐
      │                 │ createdAt    │           │
      │                 └──────────────┘           │
      └──────────────────────────────────────────<─┘
```

---

### 核心表结构

#### users（用户表）

```sql
CREATE TABLE `users` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `username` VARCHAR(50) NOT NULL UNIQUE,
  `email` VARCHAR(100) NOT NULL UNIQUE,
  `password` VARCHAR(255) NOT NULL,
  `avatar` VARCHAR(255),
  `bio` TEXT,
  `membershipType` VARCHAR(20) DEFAULT 'free',
  `membershipExpiresAt` DATETIME,
  `createdAt` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updatedAt` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX `idx_email` (`email`),
  INDEX `idx_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### novels（小说表）

```sql
CREATE TABLE `novels` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `title` VARCHAR(200) NOT NULL,
  `summary` TEXT,
  `content` LONGTEXT NOT NULL,
  `category` VARCHAR(50),
  `tags` TEXT,
  `coverType` VARCHAR(20) DEFAULT 'text',
  `coverData` TEXT,
  `views` INT DEFAULT 0,
  `likes` INT DEFAULT 0,
  `favorites` INT DEFAULT 0,
  `status` VARCHAR(20) DEFAULT 'draft',
  `accessLevel` VARCHAR(20) DEFAULT 'free',
  `authorId` INT NOT NULL,
  `publishedAt` DATETIME,
  `createdAt` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updatedAt` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX `idx_authorId` (`authorId`),
  INDEX `idx_status` (`status`),
  INDEX `idx_category` (`category`),
  INDEX `idx_createdAt` (`createdAt`),
  FULLTEXT `ft_title_summary` (`title`, `summary`),
  
  FOREIGN KEY (`authorId`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### comments（评论表）

```sql
CREATE TABLE `comments` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `content` TEXT NOT NULL,
  `novelId` INT NOT NULL,
  `userId` INT NOT NULL,
  `createdAt` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updatedAt` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX `idx_novelId` (`novelId`),
  INDEX `idx_userId` (`userId`),
  
  FOREIGN KEY (`novelId`) REFERENCES `novels`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`userId`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### likes（点赞表）

```sql
CREATE TABLE `likes` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `novelId` INT NOT NULL,
  `userId` INT NOT NULL,
  `createdAt` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_novel_user` (`novelId`, `userId`),
  INDEX `idx_novelId` (`novelId`),
  INDEX `idx_userId` (`userId`),
  
  FOREIGN KEY (`novelId`) REFERENCES `novels`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`userId`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### favorites（收藏表）

```sql
CREATE TABLE `favorites` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `novelId` INT NOT NULL,
  `userId` INT NOT NULL,
  `createdAt` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_novel_user` (`novelId`, `userId`),
  INDEX `idx_novelId` (`novelId`),
  INDEX `idx_userId` (`userId`),
  
  FOREIGN KEY (`novelId`) REFERENCES `novels`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`userId`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### 索引策略

```yaml
高频查询字段:
  - users.email         # 登录
  - users.username      # 用户查找
  - novels.authorId     # 作者作品列表
  - novels.category     # 分类浏览
  - novels.status       # 状态筛选

唯一约束:
  - users.email
  - users.username
  - likes(novelId, userId)
  - favorites(novelId, userId)

全文索引:
  - novels(title, summary)  # 搜索功能
```

---

## 🔌 接口设计

### RESTful API规范

```
GET     /api/novels           # 获取列表
GET     /api/novels/:id       # 获取详情
POST    /api/novels           # 创建
PUT     /api/novels/:id       # 更新
DELETE  /api/novels/:id       # 删除

资源嵌套：
GET     /api/novels/:id/comments      # 获取小说的评论
POST    /api/novels/:id/comments      # 为小说添加评论
```

---

### 统一响应格式

```typescript
// 成功响应
interface SuccessResponse<T> {
  success: true
  data: T
  message?: string
}

// 失败响应
interface ErrorResponse {
  success: false
  error: {
    code: string
    message: string
    details?: any
  }
}

// 分页响应
interface PaginatedResponse<T> {
  success: true
  data: {
    items: T[]
    pagination: {
      page: number
      pageSize: number
      total: number
      totalPages: number
    }
  }
}
```

---

## 🔒 安全架构

### 认证流程

```
1. 用户登录
   ↓
2. 验证用户名/密码
   ↓
3. 生成JWT Token
   - Payload: { userId, username, role }
   - 过期时间: 24小时
   ↓
4. 返回Token给客户端
   ↓
5. 客户端存储Token（localStorage）
   ↓
6. 后续请求携带Token
   - Header: Authorization: Bearer <token>
   ↓
7. 服务端验证Token
   - 验证签名
   - 检查过期时间
   ↓
8. 允许访问 / 拒绝访问
```

---

### 密码加密

```typescript
// 注册时加密
const salt = await bcrypt.genSalt(10)
const hashedPassword = await bcrypt.hash(password, salt)

// 登录时验证
const isValid = await bcrypt.compare(inputPassword, storedHash)
```

---

### 权限控制

```typescript
// 角色定义
enum UserRole {
  GUEST = 'guest',       // 游客
  USER = 'user',         // 普通用户
  MEMBER = 'member',     // 会员
  ADMIN = 'admin'        // 管理员
}

// 权限矩阵
const permissions = {
  'novel:read': ['guest', 'user', 'member', 'admin'],
  'novel:create': ['user', 'member', 'admin'],
  'novel:delete': ['admin'],  // 只有管理员
  'comment:create': ['user', 'member', 'admin'],
}
```

---

## ⚡ 性能优化

### 缓存策略

```yaml
Redis缓存层次:

1. 热点数据缓存（1小时）:
   - 首页推荐小说
   - 热门分类
   - 排行榜

2. 用户会话缓存（24小时）:
   - 登录状态
   - 用户信息

3. 查询结果缓存（30分钟）:
   - 小说列表
   - 搜索结果

缓存失效策略:
   - 数据更新时主动清除
   - 设置过期时间
   - LRU淘汰
```

---

### 数据库优化

```yaml
查询优化:
  - 使用索引
  - 避免N+1查询
  - 使用JOIN代替多次查询
  - 分页查询

连接池配置:
  - 最小连接数: 5
  - 最大连接数: 20
  - 连接超时: 10s

慢查询监控:
  - 记录>1s的查询
  - 定期分析优化
```

---

### 前端优化

```yaml
代码分割:
  - 路由懒加载
  - 组件异步加载
  - 第三方库按需引入

资源优化:
  - 图片懒加载
  - 图片压缩
  - CDN加速
  - Gzip压缩

缓存策略:
  - Service Worker
  - HTTP缓存
  - LocalStorage
```

---

## 🚀 部署架构

### 生产环境架构

```
                    ┌──────────────┐
                    │  用户浏览器   │
                    └───────┬──────┘
                            │
                    ┌───────▼──────┐
                    │   DNS解析    │
                    │ xs.momofx.cn │
                    └───────┬──────┘
                            │
                    ┌───────▼──────────┐
                    │   CDN加速        │
                    │   (静态资源)      │
                    └───────┬──────────┘
                            │
                    ┌───────▼──────────┐
                    │   Nginx          │
                    │   (反向代理+SSL)  │
                    └────┬────────┬────┘
                         │        │
                 ┌───────▼──┐  ┌─▼─────────┐
                 │ 前端静态  │  │ 后端API   │
                 │ 文件      │  │ Node.js   │
                 └──────────┘  └─┬─────────┘
                                 │
                         ┌───────┼────────┐
                         │       │        │
                      ┌──▼──┐ ┌─▼──┐  ┌─▼──┐
                      │MySQL│ │Redis│ │OSS  │
                      └─────┘ └────┘  └────┘
```

---

### 服务器配置

```yaml
服务器环境:
  OS: CentOS 7 / Ubuntu 20.04
  CPU: 2核+
  内存: 4GB+
  硬盘: 50GB+

宝塔面板:
  - Nginx 1.22
  - MySQL 8.0
  - Redis 7.0
  - PM2管理器
  - Node.js 18.x

域名配置:
  - xs.momofx.cn → 前端
  - xs.momofx.cn/api → 后端API

SSL证书:
  - Let's Encrypt（免费）
  - 自动续期
```

---

### 进程管理（PM2）

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'novel-api',
    script: './dist/server.js',
    instances: 2,           // 2个进程
    exec_mode: 'cluster',   // 集群模式
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss'
  }]
}
```

---

### 监控与日志

```yaml
日志收集:
  - 应用日志: PM2日志
  - 错误日志: error.log
  - 访问日志: Nginx access.log

监控指标:
  - CPU使用率
  - 内存使用率
  - 磁盘使用率
  - API响应时间
  - 错误率

告警机制:
  - CPU > 80% → 邮件告警
  - 错误率 > 5% → 短信告警
  - 服务宕机 → 立即通知
```

---

## 📊 性能目标

```yaml
响应时间:
  - API响应: < 200ms
  - 页面加载: < 2s
  - 首屏渲染: < 1s

并发能力:
  - 支持1000+ 并发用户
  - QPS: 500+

可用性:
  - 正常运行时间: 99.9%
  - 错误率: < 0.1%

数据库:
  - 查询响应: < 100ms
  - 连接池利用率: < 80%
```

---

## 🔄 扩展性设计

### 水平扩展

```
当前架构 → 单机部署
  ↓
负载增加 → Nginx负载均衡 + 多实例
  ↓
继续增长 → 数据库读写分离
  ↓
高并发  → 微服务拆分
```

---

### 微服务预留

```
当前单体应用可拆分为:

- 认证服务（Auth Service）
- 用户服务（User Service）
- 小说服务（Novel Service）
- 评论服务（Comment Service）
- 搜索服务（Search Service）
- 通知服务（Notification Service）
```

---

## ✅ 架构验收标准

```
✅ 技术选型合理
✅ 分层清晰
✅ 接口设计规范
✅ 数据库设计合理
✅ 安全措施完善
✅ 性能目标明确
✅ 可扩展性良好
✅ 文档完整
```

---

**架构师：** 工程师A  
**评审日期：** 待定  
**最后更新：** 2025-10-27  
**版本：** v1.0

