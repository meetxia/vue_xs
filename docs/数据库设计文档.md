# 🗄️ 数据库设计文档

**项目：** MOMO炒饭店小说网站 V2.0  
**数据库：** MySQL 8.0  
**ORM：** Prisma  
**设计者：** 工程师A + 工程师C  
**设计日期：** 2025-10-27

---

## 📊 数据库概览

```yaml
数据库名称: momo_novel_db
字符集: utf8mb4
排序规则: utf8mb4_unicode_ci
引擎: InnoDB
时区: +08:00 (Asia/Shanghai)

核心表数量: 5
辅助表数量: 0
总表数量: 5
```

---

## 📐 ER图（实体关系图）

```
┌─────────────┐              ┌──────────────┐
│    User     │              │    Novel     │
│  (用户表)    │◄─────────────┤  (小说表)     │
├─────────────┤   1      n   ├──────────────┤
│ id (PK)     │              │ id (PK)      │
│ username    │              │ title        │
│ email       │              │ content      │
│ password    │              │ authorId(FK) │
│ ...         │              │ ...          │
└──────┬──────┘              └──────┬───────┘
       │                            │
       │ 1                          │ 1
       │                            │
       │ n                          │ n
       │                            │
┌──────▼──────┐              ┌──────▼───────┐
│   Comment   │              │     Like     │
│  (评论表)    │              │  (点赞表)     │
├─────────────┤              ├──────────────┤
│ id (PK)     │              │ id (PK)      │
│ content     │              │ novelId (FK) │
│ novelId(FK) │              │ userId (FK)  │
│ userId (FK) │              │ createdAt    │
└─────────────┘              └──────────────┘
                                     
                             ┌──────────────┐
                             │   Favorite   │
                             │  (收藏表)     │
                             ├──────────────┤
                             │ id (PK)      │
                             │ novelId (FK) │
                             │ userId (FK)  │
                             │ createdAt    │
                             └──────────────┘
```

---

## 📋 数据表详细设计

### 1. users（用户表）

**用途：** 存储用户账号信息

| 字段名 | 类型 | 长度 | 默认值 | 约束 | 说明 |
|-------|------|-----|--------|------|------|
| id | INT | - | AUTO_INCREMENT | PRIMARY KEY | 用户ID |
| username | VARCHAR | 50 | - | UNIQUE, NOT NULL | 用户名 |
| email | VARCHAR | 100 | - | UNIQUE, NOT NULL | 邮箱 |
| password | VARCHAR | 255 | - | NOT NULL | 密码（bcrypt加密）|
| avatar | VARCHAR | 255 | NULL | - | 头像URL |
| bio | TEXT | - | NULL | - | 个人简介 |
| membershipType | VARCHAR | 20 | 'free' | - | 会员类型 |
| membershipExpiresAt | DATETIME | - | NULL | - | 会员过期时间 |
| createdAt | DATETIME | - | CURRENT_TIMESTAMP | NOT NULL | 创建时间 |
| updatedAt | DATETIME | - | CURRENT_TIMESTAMP | ON UPDATE | 更新时间 |

**索引：**
```sql
PRIMARY KEY (id)
UNIQUE INDEX uk_username (username)
UNIQUE INDEX uk_email (email)
INDEX idx_email (email)                 -- 登录查询
INDEX idx_membership (membershipType)    -- 会员查询
```

**会员类型枚举：**
- `free` - 免费用户
- `basic` - 基础会员
- `premium` - 高级会员
- `vip` - VIP会员

---

### 2. novels（小说表）

**用途：** 存储小说内容和元信息

| 字段名 | 类型 | 长度 | 默认值 | 约束 | 说明 |
|-------|------|-----|--------|------|------|
| id | INT | - | AUTO_INCREMENT | PRIMARY KEY | 小说ID |
| title | VARCHAR | 200 | - | NOT NULL | 标题 |
| summary | TEXT | - | NULL | - | 简介 |
| content | LONGTEXT | - | - | NOT NULL | 正文内容 |
| category | VARCHAR | 50 | NULL | - | 分类 |
| tags | TEXT | - | NULL | - | 标签（JSON数组）|
| coverType | VARCHAR | 20 | 'text' | - | 封面类型 |
| coverData | TEXT | - | NULL | - | 封面数据 |
| views | INT | - | 0 | - | 浏览量 |
| likes | INT | - | 0 | - | 点赞数 |
| favorites | INT | - | 0 | - | 收藏数 |
| status | VARCHAR | 20 | 'draft' | - | 状态 |
| accessLevel | VARCHAR | 20 | 'free' | - | 访问级别 |
| authorId | INT | - | - | FOREIGN KEY | 作者ID |
| publishedAt | DATETIME | - | NULL | - | 发布时间 |
| createdAt | DATETIME | - | CURRENT_TIMESTAMP | NOT NULL | 创建时间 |
| updatedAt | DATETIME | - | CURRENT_TIMESTAMP | ON UPDATE | 更新时间 |

**索引：**
```sql
PRIMARY KEY (id)
INDEX idx_authorId (authorId)             -- 作者作品列表
INDEX idx_status (status)                 -- 状态筛选
INDEX idx_category (category)             -- 分类浏览
INDEX idx_createdAt (createdAt)           -- 时间排序
INDEX idx_views (views)                   -- 热门排序
INDEX idx_likes (likes)                   -- 点赞排序
FULLTEXT INDEX ft_title_summary (title, summary)  -- 全文搜索
```

**外键约束：**
```sql
FOREIGN KEY (authorId) REFERENCES users(id) ON DELETE CASCADE
```

**状态枚举：**
- `draft` - 草稿
- `published` - 已发布
- `archived` - 已归档
- `deleted` - 已删除（软删除）

**访问级别：**
- `free` - 免费
- `member` - 会员
- `premium` - 高级会员

**封面类型：**
- `text` - 纯文字封面
- `image` - 图片封面
- `gradient` - 渐变色封面

---

### 3. comments（评论表）

**用途：** 存储用户评论

| 字段名 | 类型 | 长度 | 默认值 | 约束 | 说明 |
|-------|------|-----|--------|------|------|
| id | INT | - | AUTO_INCREMENT | PRIMARY KEY | 评论ID |
| content | TEXT | - | - | NOT NULL | 评论内容 |
| novelId | INT | - | - | FOREIGN KEY | 小说ID |
| userId | INT | - | - | FOREIGN KEY | 用户ID |
| createdAt | DATETIME | - | CURRENT_TIMESTAMP | NOT NULL | 创建时间 |
| updatedAt | DATETIME | - | CURRENT_TIMESTAMP | ON UPDATE | 更新时间 |

**索引：**
```sql
PRIMARY KEY (id)
INDEX idx_novelId (novelId)      -- 按小说查询评论
INDEX idx_userId (userId)        -- 按用户查询评论
INDEX idx_createdAt (createdAt)  -- 时间排序
```

**外键约束：**
```sql
FOREIGN KEY (novelId) REFERENCES novels(id) ON DELETE CASCADE
FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE
```

---

### 4. likes（点赞表）

**用途：** 存储用户对小说的点赞记录

| 字段名 | 类型 | 长度 | 默认值 | 约束 | 说明 |
|-------|------|-----|--------|------|------|
| id | INT | - | AUTO_INCREMENT | PRIMARY KEY | 点赞ID |
| novelId | INT | - | - | FOREIGN KEY | 小说ID |
| userId | INT | - | - | FOREIGN KEY | 用户ID |
| createdAt | DATETIME | - | CURRENT_TIMESTAMP | NOT NULL | 创建时间 |

**索引：**
```sql
PRIMARY KEY (id)
UNIQUE INDEX uk_novel_user (novelId, userId)  -- 防止重复点赞
INDEX idx_novelId (novelId)                   -- 按小说查询
INDEX idx_userId (userId)                     -- 按用户查询
```

**外键约束：**
```sql
FOREIGN KEY (novelId) REFERENCES novels(id) ON DELETE CASCADE
FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE
```

---

### 5. favorites（收藏表）

**用途：** 存储用户对小说的收藏记录

| 字段名 | 类型 | 长度 | 默认值 | 约束 | 说明 |
|-------|------|-----|--------|------|------|
| id | INT | - | AUTO_INCREMENT | PRIMARY KEY | 收藏ID |
| novelId | INT | - | - | FOREIGN KEY | 小说ID |
| userId | INT | - | - | FOREIGN KEY | 用户ID |
| createdAt | DATETIME | - | CURRENT_TIMESTAMP | NOT NULL | 创建时间 |

**索引：**
```sql
PRIMARY KEY (id)
UNIQUE INDEX uk_novel_user (novelId, userId)  -- 防止重复收藏
INDEX idx_novelId (novelId)                   -- 按小说查询
INDEX idx_userId (userId)                     -- 按用户查询
INDEX idx_createdAt (createdAt)               -- 时间排序
```

**外键约束：**
```sql
FOREIGN KEY (novelId) REFERENCES novels(id) ON DELETE CASCADE
FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE
```

---

## 🔍 索引策略

### 查询优化索引

```sql
-- 1. 用户登录（高频）
SELECT * FROM users WHERE email = ?
→ INDEX idx_email (email)

-- 2. 作者作品列表（高频）
SELECT * FROM novels WHERE authorId = ?
→ INDEX idx_authorId (authorId)

-- 3. 分类浏览（高频）
SELECT * FROM novels WHERE category = ? AND status = 'published'
→ INDEX idx_category (category)
→ INDEX idx_status (status)

-- 4. 小说搜索（中频）
SELECT * FROM novels WHERE MATCH(title, summary) AGAINST(?)
→ FULLTEXT INDEX ft_title_summary (title, summary)

-- 5. 热门排序（中频）
SELECT * FROM novels ORDER BY views DESC LIMIT 20
→ INDEX idx_views (views)

-- 6. 用户收藏列表（中频）
SELECT * FROM favorites WHERE userId = ?
→ INDEX idx_userId (userId)
```

---

## 📊 数据统计

### 预估数据量（1年后）

```yaml
users:        10,000 条     (~2MB)
novels:       50,000 条     (~500MB，包含内容)
comments:     200,000 条    (~50MB)
likes:        500,000 条    (~10MB)
favorites:    300,000 条    (~8MB)

总计:         ~570MB
```

### 存储优化建议

```yaml
短期（0-1年）:
  - 使用单库单表
  - 定期清理软删除数据
  - 压缩历史数据

中期（1-3年）:
  - content字段考虑分表存储
  - 冷热数据分离
  - 使用Redis缓存热点数据

长期（3年+）:
  - 分库分表
  - NoSQL辅助存储
  - CDN存储大文件
```

---

## 🔒 数据安全

### 敏感数据处理

```yaml
密码:
  - bcrypt加密（cost=10）
  - 不可逆加密
  - 查询时不返回

邮箱:
  - 唯一索引
  - 脱敏显示（前端）
  
个人信息:
  - 访问权限控制
  - 日志审计
```

### 备份策略

```yaml
全量备份:
  - 频率: 每天凌晨3点
  - 保留: 最近7天

增量备份:
  - 频率: 每小时
  - 保留: 最近24小时

binlog:
  - 保留: 最近3天
  - 用于增量恢复
```

---

## 🚀 性能优化

### 查询优化

```sql
-- ❌ 避免：SELECT *
SELECT * FROM novels WHERE id = 1

-- ✅ 推荐：只查询需要的字段
SELECT id, title, summary, authorId FROM novels WHERE id = 1

-- ❌ 避免：N+1查询
-- 先查小说
SELECT * FROM novels
-- 再循环查作者
SELECT * FROM users WHERE id = ?

-- ✅ 推荐：JOIN查询
SELECT n.*, u.username, u.avatar
FROM novels n
LEFT JOIN users u ON n.authorId = u.id
```

### 分页优化

```sql
-- ❌ 深分页性能差
SELECT * FROM novels LIMIT 100000, 20

-- ✅ 使用游标分页
SELECT * FROM novels 
WHERE id > last_id
ORDER BY id
LIMIT 20
```

---

## 📝 Prisma Schema

完整的Prisma Schema定义：

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int       @id @default(autoincrement())
  username            String    @unique @db.VarChar(50)
  email               String    @unique @db.VarChar(100)
  password            String    @db.VarChar(255)
  avatar              String?   @db.VarChar(255)
  bio                 String?   @db.Text
  membershipType      String?   @default("free") @db.VarChar(20)
  membershipExpiresAt DateTime? @db.DateTime(0)
  
  novels              Novel[]
  comments            Comment[]
  likes               Like[]
  favorites           Favorite[]
  
  createdAt           DateTime  @default(now()) @db.DateTime(0)
  updatedAt           DateTime  @updatedAt @db.DateTime(0)

  @@index([email])
  @@index([username])
  @@map("users")
}

model Novel {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(200)
  summary     String?   @db.Text
  content     String    @db.LongText
  category    String?   @db.VarChar(50)
  tags        String?   @db.Text
  coverType   String    @default("text") @db.VarChar(20)
  coverData   String?   @db.Text
  views       Int       @default(0)
  likes       Int       @default(0)
  favorites   Int       @default(0)
  status      String    @default("draft") @db.VarChar(20)
  accessLevel String    @default("free") @db.VarChar(20)
  
  authorId    Int
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  comments    Comment[]
  likeList    Like[]
  favoriteList Favorite[]
  
  publishedAt DateTime? @db.DateTime(0)
  createdAt   DateTime  @default(now()) @db.DateTime(0)
  updatedAt   DateTime  @updatedAt @db.DateTime(0)

  @@index([authorId])
  @@index([status])
  @@index([category])
  @@index([views])
  @@fulltext([title, summary])
  @@map("novels")
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  
  novelId   Int
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@index([novelId])
  @@index([userId])
  @@map("comments")
}

model Like {
  id        Int      @id @default(autoincrement())
  
  novelId   Int
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now()) @db.DateTime(0)

  @@unique([novelId, userId])
  @@index([novelId])
  @@index([userId])
  @@map("likes")
}

model Favorite {
  id        Int      @id @default(autoincrement())
  
  novelId   Int
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now()) @db.DateTime(0)

  @@unique([novelId, userId])
  @@index([novelId])
  @@index([userId])
  @@map("favorites")
}
```

---

## 🧪 测试数据

### 初始化测试数据SQL

```sql
-- 插入测试用户
INSERT INTO users (username, email, password, avatar, bio, membershipType) VALUES
('admin', 'admin@momo.com', '$2b$10$...', 'https://...', '管理员', 'vip'),
('author1', 'author1@momo.com', '$2b$10$...', 'https://...', '作者1', 'premium'),
('reader1', 'reader1@momo.com', '$2b$10$...', 'https://...', '读者1', 'free');

-- 插入测试小说
INSERT INTO novels (title, summary, content, category, authorId, status) VALUES
('测试小说1', '这是一个测试小说的简介', '这是小说的正文内容...', 'romance', 2, 'published'),
('测试小说2', '另一个测试小说', '另一个小说的内容...', 'fantasy', 2, 'published');

-- 插入测试评论
INSERT INTO comments (content, novelId, userId) VALUES
('写得真好！', 1, 3),
('期待更新', 1, 3);
```

---

## ✅ 验收标准

```
✅ 所有表创建成功
✅ 所有索引创建成功
✅ 外键关系正确
✅ 测试数据插入成功
✅ 查询性能达标（<100ms）
✅ Prisma Schema验证通过
```

---

**设计者：** 工程师A + 工程师C  
**审核者：** 工程师A  
**最后更新：** 2025-10-27  
**版本：** v1.0

