<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹èµæ”¶è—åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .interaction-buttons {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #f0f0f0;
        }
        .btn.liked {
            color: #ff4d4f;
            border-color: #ff4d4f;
        }
        .btn.favorited {
            color: #faad14;
            border-color: #faad14;
        }
        .status {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ“š ç‚¹èµæ”¶è—åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-card">
        <h2>å°è¯´ID: 1 - éƒ½å¸‚éœ¸æ€»çš„å°å¨‡å¦»</h2>
        <div class="interaction-buttons">
            <button class="btn like-btn" onclick="testLike(1)">
                <span class="like-icon">ğŸ¤</span>
                <span class="like-count">234</span>
            </button>
            <button class="btn favorite-btn" onclick="testFavorite(1)">
                <span class="favorite-icon">â˜†</span>
                <span class="favorite-count">89</span>
            </button>
        </div>
        <div class="status" id="status-1">å‡†å¤‡æµ‹è¯•...</div>
    </div>

    <div class="test-card">
        <h2>å°è¯´ID: 2 - æ ¡å›­é‡Œçš„å°ç¾å¥½</h2>
        <div class="interaction-buttons">
            <button class="btn like-btn" onclick="testLike(2)">
                <span class="like-icon">ğŸ¤</span>
                <span class="like-count">156</span>
            </button>
            <button class="btn favorite-btn" onclick="testFavorite(2)">
                <span class="favorite-icon">â˜†</span>
                <span class="favorite-count">42</span>
            </button>
        </div>
        <div class="status" id="status-2">å‡†å¤‡æµ‹è¯•...</div>
    </div>

    <div class="test-card">
        <h2>API æµ‹è¯•ç»“æœ</h2>
        <div class="status" id="api-log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        // ç”¨æˆ·äº¤äº’çŠ¶æ€ç®¡ç†
        const userInteractions = {
            likes: JSON.parse(localStorage.getItem('user_likes') || '[]'),
            favorites: JSON.parse(localStorage.getItem('user_favorites') || '[]'),
            
            isLiked(novelId) {
                return this.likes.includes(novelId);
            },
            
            isFavorited(novelId) {
                return this.favorites.includes(novelId);
            },
            
            addLike(novelId) {
                if (!this.isLiked(novelId)) {
                    this.likes.push(novelId);
                    localStorage.setItem('user_likes', JSON.stringify(this.likes));
                }
            },
            
            removeLike(novelId) {
                this.likes = this.likes.filter(id => id !== novelId);
                localStorage.setItem('user_likes', JSON.stringify(this.likes));
            },
            
            addFavorite(novelId) {
                if (!this.isFavorited(novelId)) {
                    this.favorites.push(novelId);
                    localStorage.setItem('user_favorites', JSON.stringify(this.favorites));
                }
            },
            
            removeFavorite(novelId) {
                this.favorites = this.favorites.filter(id => id !== novelId);
                localStorage.setItem('user_favorites', JSON.stringify(this.favorites));
            }
        };

        // æ—¥å¿—è®°å½•
        function log(message) {
            const logEl = document.getElementById('api-log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML = `[${timestamp}] ${message}<br>` + logEl.innerHTML;
        }

        // æµ‹è¯•ç‚¹èµåŠŸèƒ½
        async function testLike(novelId) {
            const btn = event.target.closest('.like-btn');
            const icon = btn.querySelector('.like-icon');
            const count = btn.querySelector('.like-count');
            const status = document.getElementById(`status-${novelId}`);
            
            const isCurrentlyLiked = userInteractions.isLiked(novelId);
            const method = isCurrentlyLiked ? 'DELETE' : 'POST';
            const url = `/api/novels/${novelId}/like`;
            
            log(`${isCurrentlyLiked ? 'å–æ¶ˆ' : ''}ç‚¹èµå°è¯´ ${novelId}...`);
            
            try {
                // æ›´æ–°UI
                if (isCurrentlyLiked) {
                    icon.textContent = 'ğŸ¤';
                    btn.classList.remove('liked');
                    userInteractions.removeLike(novelId);
                } else {
                    icon.textContent = 'â¤ï¸';
                    btn.classList.add('liked');
                    userInteractions.addLike(novelId);
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    count.textContent = result.data.likes;
                    status.textContent = `âœ… ${result.message} - ç‚¹èµæ•°: ${result.data.likes}`;
                    log(`âœ… ${result.message} - å°è¯´${novelId}ç‚¹èµæ•°: ${result.data.likes}`);
                } else {
                    status.textContent = `âŒ ${result.message}`;
                    log(`âŒ ç‚¹èµå¤±è´¥: ${result.message}`);
                    // å›æ»šUI
                    if (!isCurrentlyLiked) {
                        icon.textContent = 'ğŸ¤';
                        btn.classList.remove('liked');
                        userInteractions.removeLike(novelId);
                    } else {
                        icon.textContent = 'â¤ï¸';
                        btn.classList.add('liked');
                        userInteractions.addLike(novelId);
                    }
                }
            } catch (error) {
                console.error('ç‚¹èµè¯·æ±‚å¤±è´¥:', error);
                status.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
                log(`âŒ ç‚¹èµç½‘ç»œé”™è¯¯: ${error.message}`);
                // å›æ»šUI
                if (!isCurrentlyLiked) {
                    icon.textContent = 'ğŸ¤';
                    btn.classList.remove('liked');
                    userInteractions.removeLike(novelId);
                } else {
                    icon.textContent = 'â¤ï¸';
                    btn.classList.add('liked');
                    userInteractions.addLike(novelId);
                }
            }
        }

        // æµ‹è¯•æ”¶è—åŠŸèƒ½
        async function testFavorite(novelId) {
            const btn = event.target.closest('.favorite-btn');
            const icon = btn.querySelector('.favorite-icon');
            const count = btn.querySelector('.favorite-count');
            const status = document.getElementById(`status-${novelId}`);
            
            const isCurrentlyFavorited = userInteractions.isFavorited(novelId);
            const method = isCurrentlyFavorited ? 'DELETE' : 'POST';
            const url = `/api/novels/${novelId}/favorite`;
            
            log(`${isCurrentlyFavorited ? 'å–æ¶ˆ' : ''}æ”¶è—å°è¯´ ${novelId}...`);
            
            try {
                // æ›´æ–°UI
                if (isCurrentlyFavorited) {
                    icon.textContent = 'â˜†';
                    btn.classList.remove('favorited');
                    userInteractions.removeFavorite(novelId);
                } else {
                    icon.textContent = 'â­';
                    btn.classList.add('favorited');
                    userInteractions.addFavorite(novelId);
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    count.textContent = result.data.favorites;
                    status.textContent = `âœ… ${result.message} - æ”¶è—æ•°: ${result.data.favorites}`;
                    log(`âœ… ${result.message} - å°è¯´${novelId}æ”¶è—æ•°: ${result.data.favorites}`);
                } else {
                    status.textContent = `âŒ ${result.message}`;
                    log(`âŒ æ”¶è—å¤±è´¥: ${result.message}`);
                    // å›æ»šUI
                    if (!isCurrentlyFavorited) {
                        icon.textContent = 'â˜†';
                        btn.classList.remove('favorited');
                        userInteractions.removeFavorite(novelId);
                    } else {
                        icon.textContent = 'â­';
                        btn.classList.add('favorited');
                        userInteractions.addFavorite(novelId);
                    }
                }
            } catch (error) {
                console.error('æ”¶è—è¯·æ±‚å¤±è´¥:', error);
                status.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
                log(`âŒ æ”¶è—ç½‘ç»œé”™è¯¯: ${error.message}`);
                // å›æ»šUI
                if (!isCurrentlyFavorited) {
                    icon.textContent = 'â˜†';
                    btn.classList.remove('favorited');
                    userInteractions.removeFavorite(novelId);
                } else {
                    icon.textContent = 'â­';
                    btn.classList.add('favorited');
                    userInteractions.addFavorite(novelId);
                }
            }
        }

        // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
        function initializeUI() {
            [1, 2].forEach(novelId => {
                const likeBtn = document.querySelector(`[onclick="testLike(${novelId})"]`);
                const favoriteBtn = document.querySelector(`[onclick="testFavorite(${novelId})"]`);
                
                if (userInteractions.isLiked(novelId)) {
                    likeBtn.querySelector('.like-icon').textContent = 'â¤ï¸';
                    likeBtn.classList.add('liked');
                }
                
                if (userInteractions.isFavorited(novelId)) {
                    favoriteBtn.querySelector('.favorite-icon').textContent = 'â­';
                    favoriteBtn.classList.add('favorited');
                }
            });
            
            log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>