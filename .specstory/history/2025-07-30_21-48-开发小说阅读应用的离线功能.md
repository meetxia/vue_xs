<!-- Generated by SpecStory -->

# 开发小说阅读应用的离线功能 (2025-07-31 05:48:50)

_**User**_

请帮我在现有的小说阅读应用中开发离线阅读功能。这是一个高优先级功能，需要实现以下具体功能模块：

**核心功能要求：**
1. **一键离线缓存系统**
   - 实现小说章节内容的本地存储功能
   - 支持单章节和整本小说的下载选项
   - 使用浏览器的IndexedDB或localStorage进行数据持久化

2. **智能缓存管理**
   - 实现缓存大小限制和自动清理机制
   - 根据最后阅读时间自动清理过期缓存
   - 提供手动清理缓存的用户界面

3. **批量下载功能**
   - 支持从收藏列表批量选择小说进行下载
   - 实现下载队列管理，避免同时下载过多内容
   - 提供下载进度条和状态显示

4. **离线阅读体验**
   - 检测网络状态，自动切换到离线模式
   - 离线状态下的阅读进度记录和同步
   - 离线内容的搜索和导航功能

5. **用户界面要求**
   - 在小说详情页添加"离线下载"按钮
   - 创建离线管理页面，显示已下载内容和存储占用
   - 在阅读器中显示离线状态指示器
   - 提供离线内容可用性提醒

**技术实现要求：**
- 使用现有的前端技术栈（请先分析当前项目的技术架构）
- 确保与现有的用户认证和数据同步系统兼容
- 实现渐进式Web应用(PWA)特性以支持离线功能
- 优化移动端体验，考虑触摸操作和响应式设计

**开发步骤建议：**
1. 首先分析现有代码结构和数据模型
2. 设计离线存储的数据结构和API接口
3. 实现核心的下载和缓存功能
4. 开发用户界面组件
5. 集成到现有的阅读器和导航系统中
6. 进行测试和性能优化

请先分析当前项目的代码结构，然后制定详细的开发计划并逐步实现这些功能。

---

_**Assistant**_



---

# 离线阅读功能开发计划

## 1. 项目代码结构分析

---

<details>
            <summary>Searched codebase "reader.js 文件中的loadNovel和章节加载功能" • **15** results</summary>
        
| File | Lines |
|------|-------|
| `public/js/reader.js` | Lundefined-998 |
| `public/js/reader.js` | Lundefined-998 |
| `public/js/reader.js` | Lundefined-998 |
| `public/js/main.js` | L701-792 |
| `public/js/reader.js` | Lundefined-998 |
| `public/js/reader.js` | Lundefined-998 |
| `public/js/main.js` | L1640-1765 |
| `server.js` | L48-80 |
| `public/read.html` | L262-297 |
| `public/js/reader.js` | L1-998 |
| `public/js/reader.js` | Lundefined-998 |
| `server.js` | L661-752 |
| `public/js/reader.js` | Lundefined-998 |
| `public/js/admin.js` | Lundefined-1292 |
| `public/js/reader.js` | Lundefined-998 |

</details>

---

让我进一步查看阅读器如何加载小说内容，这对于实现离线功能至关重要：

---

Read file: public/js/reader.js

---

让我查看小说加载的具体实现和数据存储方式：

---

Read file: public/js/reader.js

---

我需要了解进度保存相关的实现：

---

Read file: public/js/reader.js

---

让我查看API的实现，特别是如何获取小说数据：

---

Read file: server.js

---

让我再查看一下小说数据的获取API：

---

Read file: server.js

---

让我查找与小说数据获取相关的API：

---

<details>
            <summary>Grep search for "app\.get\('\/api\/novels" • **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///h%3A/momo-ruanjiansheji/axs_html/server.js` | L661 | `app.get('/api/novels', (req, res) => {` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/server.js` | L723 | `app.get('/api/novels/:id', (req, res) => {` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/server.js` | L1123 | `app.get('/api/novels/:id/interactions', (req, res) => {` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/server.js` | L1219 | `app.get('/api/novels/:id/comments', (req, res) => {` |

</details>

---

让我查看小说数据的获取实现：

---

Read file: server.js

---

现在，让我看一下html页面和js中关于localStorage的使用情况：

---

<details>
            <summary>Grep search for "localStorage" • **18** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///h%3A/momo-ruanjiansheji/axs_html/%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.md` | L408 | `this.token = localStorage.getItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.md` | L417 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/xiaohongshu-novel-site-doc.md` | L257 | `localStorage.setItem(`novel-${novelId}-progress`, progress);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/test-interactions.html` | L98 | `likes: JSON.parse(localStorage.getItem('user_likes') || '[]'),` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/test-interactions.html` | L99 | `favorites: JSON.parse(localStorage.getItem('user_favorites') || '[]'),` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/test-interactions.html` | L112 | `localStorage.setItem('user_likes', JSON.stringify(this.likes));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/test-interactions.html` | L118 | `localStorage.setItem('user_likes', JSON.stringify(this.likes));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/test-interactions.html` | L124 | `localStorage.setItem('user_favorites', JSON.stringify(this.favorites));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/test-interactions.html` | L130 | `localStorage.setItem('user_favorites', JSON.stringify(this.favorites));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/server.js` | L941 | `message: '草稿存储在客户端localStorage中',` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/server.js` | L949 | `// 目前草稿存储在客户端localStorage中` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/server.js` | L952 | `message: '草稿功能使用localStorage存储'` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/README.md` | L90 | `- **浏览器localStorage** - 客户端状态缓存` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/README.md` | L551 | `- 清除浏览器缓存和 localStorage` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/user-profile.js` | L4 | `this.token = localStorage.getItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/user-profile.js` | L44 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/user-profile.js` | L131 | `const savedTheme = localStorage.getItem('theme');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/user-profile.js` | L355 | `localStorage.setItem('theme', 'light');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/user-profile.js` | L359 | `localStorage.setItem('theme', 'dark');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/user-profile.js` | L366 | `localStorage.setItem('themeColor', color);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/user-profile.js` | L723 | `const savedTheme = localStorage.getItem('theme');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/reader.js` | L49 | `const saved = localStorage.getItem('readerSettings');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/reader.js` | L55 | `const saved = localStorage.getItem(`novel-${this.novelId}-progress`);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/reader.js` | L880 | `localStorage.setItem(`novel-${this.novelId}-progress`, JSON.stringify(progress));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/reader.js` | L895 | `localStorage.setItem('readerSettings', JSON.stringify(this.settings));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/reader.js` | L951 | `const lastViewed = localStorage.getItem(viewKey);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/reader.js` | L956 | `localStorage.setItem(viewKey, now.toString());` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L10 | `this.token = localStorage.getItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L36 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L42 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L212 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L1480 | `localStorage.setItem('theme', 'dark');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L1484 | `localStorage.setItem('theme', 'light');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L1531 | `const savedTheme = localStorage.getItem('theme');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/login.js` | L4 | `this.token = localStorage.getItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/login.js` | L30 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/login.js` | L35 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/login.js` | L56 | `localStorage.setItem('token', this.token);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L24 | `const token = localStorage.getItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L39 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L40 | `localStorage.removeItem('user');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L335 | `'Authorization': `Bearer ${localStorage.getItem('token')}`` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L500 | `'Authorization': `Bearer ${localStorage.getItem('token')}`` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L535 | `'Authorization': `Bearer ${localStorage.getItem('token')}`` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L565 | `'Authorization': `Bearer ${localStorage.getItem('token')}`` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/comments.js` | L634 | `'Authorization': `Bearer ${localStorage.getItem('token')}`` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L8 | `this.drafts = JSON.parse(localStorage.getItem('novelDrafts') || '[]');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L27 | `const token = localStorage.getItem('adminToken');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L28 | `const loginTime = localStorage.getItem('adminLoginTime');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L50 | `localStorage.removeItem('adminToken');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L51 | `localStorage.removeItem('adminLoginTime');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L52 | `localStorage.removeItem('adminUsername');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L86 | `const username = localStorage.getItem('adminUsername');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L370 | `localStorage.setItem('novelDrafts', JSON.stringify(this.drafts));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L496 | `localStorage.setItem('novelDrafts', JSON.stringify(this.drafts));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L63 | `const token = localStorage.getItem('adminToken');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L64 | `const loginTime = localStorage.getItem('adminLoginTime');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L85 | `const rememberedUsername = localStorage.getItem('rememberedUsername');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L194 | `localStorage.setItem('adminToken', token);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L195 | `localStorage.setItem('adminLoginTime', loginTime);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L196 | `localStorage.setItem('adminUsername', username);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L200 | `localStorage.setItem('rememberedUsername', username);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L202 | `localStorage.removeItem('rememberedUsername');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L282 | `localStorage.removeItem('adminToken');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L283 | `localStorage.removeItem('adminLoginTime');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin-login.js` | L284 | `localStorage.removeItem('adminUsername');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/.specstory/history/2025-07-30_21-48-%E5%BC%80%E5%8F%91%E5%B0%8F%E8%AF%B4%E9%98%85%E8%AF%BB%E5%BA%94%E7%94%A8%E7%9A%84%E7%A6%BB%E7%BA%BF%E5%8A%9F%E8%83%BD.md` | L12 | `- 使用浏览器的IndexedDB或localStorage进行数据持久化` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/xiaohongshu-novel-site-doc.md` | L257 | `localStorage.setItem(`novel-${novelId}-progress`, progress);` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L10 | `this.token = localStorage.getItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L36 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L42 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L212 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L1480 | `localStorage.setItem('theme', 'dark');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L1484 | `localStorage.setItem('theme', 'light');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/main.js` | L1531 | `const savedTheme = localStorage.getItem('theme');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.md` | L408 | `this.token = localStorage.getItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.md` | L417 | `localStorage.removeItem('token');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/README.md` | L90 | `- **浏览器localStorage** - 客户端状态缓存` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/README.md` | L551 | `- 清除浏览器缓存和 localStorage` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L8 | `this.drafts = JSON.parse(localStorage.getItem('novelDrafts') || '[]');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L27 | `const token = localStorage.getItem('adminToken');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L28 | `const loginTime = localStorage.getItem('adminLoginTime');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L50 | `localStorage.removeItem('adminToken');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L51 | `localStorage.removeItem('adminLoginTime');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L52 | `localStorage.removeItem('adminUsername');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L86 | `const username = localStorage.getItem('adminUsername');` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L370 | `localStorage.setItem('novelDrafts', JSON.stringify(this.drafts));` |
| `file:///h%3A/momo-ruanjiansheji/axs_html/public/js/admin.js` | L496 | `localStorage.setItem('novelDrafts', JSON.stringify(this.drafts));` |

</details>

---

最后，让我检查一下阅读页面的HTML结构：

---

Read file: public/read.html

---

基于以上分析，我已经对系统有了足够的了解。现在我可以设计并实现离线阅读功能了。

## 2. 技术架构分析

通过代码分析，我了解到该项目：

- 前端：原生JavaScript + Tailwind CSS
- 后端：Node.js + Express
- 数据存储：JSON文件
- 当前缓存：使用localStorage存储阅读进度和设置

用户通过API获取小说数据，阅读器通过JavaScript处理小说内容展示，阅读进度保存在localStorage中。

## 3. 离线阅读功能设计

### 3.1 数据存储方案

---

```diff
- 
+ // 离线阅读功能实现
+ class OfflineReaderManager {
+     constructor() {
+         this.dbName = 'novel_offline_db';
+         this.dbVersion = 1;
+         this.db = null;
+         this.maxStorageSize = 50 * 1024 * 1024; // 默认50MB存储限制
+         this.storageLimit = parseInt(localStorage.getItem('offline_storage_limit')) || this.maxStorageSize;
+         this.downloadQueue = [];
+         this.isProcessingQueue = false;
+         
+         this.initDatabase();
+         this.initNetworkListeners();
+     }
+ 
+     // 初始化IndexedDB数据库
+     async initDatabase() {
+         return new Promise((resolve, reject) => {
+             const request = indexedDB.open(this.dbName, this.dbVersion);
+             
+             request.onupgradeneeded = (event) => {
+                 const db = event.target.result;
+                 
+                 // 创建小说内容存储
+                 if (!db.objectStoreNames.contains('novels')) {
+                     const novelStore = db.createObjectStore('novels', { keyPath: 'id' });
+                     novelStore.createIndex('timestamp', 'timestamp', { unique: false });
+                 }
+                 
+                 // 创建小说章节存储
+                 if (!db.objectStoreNames.contains('chapters')) {
+                     const chapterStore = db.createObjectStore('chapters', { keyPath: 'id' });
+                     chapterStore.createIndex('novelId', 'novelId', { unique: false });
+                     chapterStore.createIndex('timestamp', 'timestamp', { unique: false });
+                 }
+                 
+                 // 创建下载任务存储
+                 if (!db.objectStoreNames.contains('downloadTasks')) {
+                     const taskStore = db.createObjectStore('downloadTasks', { keyPath: 'id', autoIncrement: true });
+                     taskStore.createIndex('status', 'status', { unique: false });
+                     taskStore.createIndex('timestamp', 'timestamp', { unique: false });
+                 }
+             };
+             
+             request.onsuccess = (event) => {
+                 this.db = event.target.result;
+                 console.log('离线阅读数据库初始化成功');
+                 resolve(this.db);
+             };
+             
+             request.onerror = (event) => {
+                 console.error('离线阅读数据库初始化失败:', event.target.error);
+                 reject(event.target.error);
+             };
+         });
+     }
+     
+     // 初始化网络状态监听
+     initNetworkListeners() {
+         window.addEventListener('online', () => {
+             console.log('网络已连接，可以同步数据');
+             this.processDownloadQueue();
+             
+             // 显示网络已连接通知
+             if (this.showToast) {
+                 this.showToast('网络已连接，正在同步数据', 'success');
+             }
+         });
+         
+         window.addEventListener('offline', () => {
+             console.log('网络已断开，切换到离线模式');
+             
+             // 显示网络已断开通知
+             if (this.showToast) {
+                 this.showToast('网络已断开，已切换到离线模式', 'info');
+             }
+         });
+     }
+     
+     // 检查是否在线
+     isOnline() {
+         return navigator.onLine;
+     }
+     
+     // 保存小说到离线存储
+     async saveNovel(novel) {
+         if (!this.db) await this.initDatabase();
+         
+         return new Promise((resolve, reject) => {
+             const transaction = this.db.transaction(['novels'], 'readwrite');
+             const store = transaction.objectStore('novels');
+             
+             // 添加时间戳用于过期处理
+             novel.timestamp = Date.now();
+             novel.size = this.estimateSize(novel);
+             
+             const request = store.put(novel);
+             
+             request.onsuccess = () => {
+                 resolve(novel);
+             };
+             
+             request.onerror = (event) => {
+                 console.error('保存小说失败:', event.target.error);
+                 reject(event.target.error);
+             };
+         });
+     }
+     
+     // 获取离线小说
+     async getNovel(novelId) {
+         if (!this.db) await this.initDatabase();
+         
+         return new Promise((resolve, reject) => {
+             const transaction = this.db.transaction(['novels'], 'readonly');
+             const store = transaction.objectStore('novels');
+             const request = store.get(parseInt(novelId));
+             
+             request.onsuccess = (event) => {
+                 const novel = event.target.result;
+                 if (novel) {
+                     // 更新最后访问时间
+                     this.updateNovelTimestamp(parseInt(novelId));
+                 }
+                 resolve(novel);
+             };
+             
+             request.onerror = (event) => {
+                 console.error('获取小说失败:', event.target.error);
+                 reject(event.target.error);
+             };
+         });
+     }
+     
+     // 更新小说的时间戳（最后访问时间）
+     async updateNovelTimestamp(novelId) {
+         if (!this.db) await this.initDatabase();
+         
+         const transaction = this.db.transaction(['novels'], 'readwrite');
+         const store = transaction.objectStore('novels');
+         
+         const request = store.get(parseInt(novelId));
+         request.onsuccess = (event) => {
+             const novel = event.target.result;
+             if (novel) {
+                 novel.timestamp = Date.now();
+                 store.put(novel);
+             }
+         };
+     }
+     
+     // 删除离线小说
+     async deleteNovel(novelId) {
+         if (!this.db) await this.initDatabase();
+         
+         return new Promise((resolve, reject) => {
+             const transaction = this.db.transaction(['novels'], 'readwrite');
+             const store = transaction.objectStore('novels');
+             const request = store.delete(parseInt(novelId));
+             
+             request.onsuccess = () => {
+                 resolve(true);
+             };
+             
+             request.onerror = (event) => {
+                 console.error('删除小说失败:', event.target.error);
+                 reject(event.target.error);
+             };
+         });
+     }
+     
+     // 获取所有离线小说列表
+     async getAllNovels() {
+         if (!this.db) await this.initDatabase();
+         
+         return new Promise((resolve, reject) => {
+             const transaction = this.db.transaction(['novels'], 'readonly');
+             const store = transaction.objectStore('novels');
+             const request = store.getAll();
+             
+             request.onsuccess = (event) => {
+                 const novels = event.target.result;
+                 resolve(novels || []);
+             };
+             
+             request.onerror = (event) => {
+                 console.error('获取离线小说列表失败:', event.target.error);
+                 reject(event.target.error);
+             };
+         });
+     }
+     
+     // 下载小说到离线存储
+     async downloadNovel(novelId) {
+         // 先检查是否已经离线保存
+         const existingNovel = await this.getNovel(novelId);
+         if (existingNovel) {
+             return { success: true, message: '小说已离线保存', novel: existingNovel };
+         }
+         
+         // 检查网络状态
+         if (!this.isOnline()) {
+             this.addToDownloadQueue(novelId);
+             return { success: false, message: '网络已断开，已添加到下载队列' };
+         }
+         
+         try {
+             const response = await fetch(`/api/novels/${novelId}`);
+             if (!response.ok) {
+                 throw new Error(`API返回错误: ${response.status}`);
+             }
+             
+             const data = await response.json();
+             if (!data.success || !data.data) {
+                 throw new Error('获取小说数据失败');
+             }
+             
+             // 检查存储空间
+             await this.checkAndCleanStorage(data.data);
+             
+             // 保存到离线存储
+             const savedNovel = await this.saveNovel(data.data);
+             
+             // 通知保存成功
+             if (this.showToast) {
+                 this.showToast(`《${savedNovel.title}》已保存到离线阅读库`, 'success');
+             }
+             
+             return { success: true, message: '小说已保存到离线阅读库', novel: savedNovel };
+         } catch (error) {
+             console.error('下载小说失败:', error);
+             
+             // 添加到下载队列，稍后重试
+             this.addToDownloadQueue(novelId);
+             
+             return { success: false, message: `下载失败: ${error.message}，已加入下载队列`, error };
+         }
+     }
+     
+     // 添加到下载队列
+     addToDownloadQueue(novelId) {
+         const task = {
+             novelId: parseInt(novelId),
+             status: 'pending',
+             timestamp: Date.now(),
+             retries: 0
+         };
+         
+         if (!this.db) {
+             this.downloadQueue.push(task);
+             return;
+         }
+         
+         const transaction = this.db.transaction(['downloadTasks'], 'readwrite');
+         const store = transaction.objectStore('downloadTasks');
+         store.add(task);
+         
+         // 如果在线且队列未处理，开始处理
+         if (this.isOnline() && !this.isProcessingQueue) {
+             this.processDownloadQueue();
+         }
+     }
+     
+     // 处理下载队列
+     async processDownloadQueue() {
+         if (!this.isOnline() || this.isProcessingQueue) return;
+         
+         this.isProcessingQueue = true;
+         
+         if (!this.db) await this.initDatabase();
+         
+         const transaction = this.db.transaction(['downloadTasks'], 'readwrite');
+         const store = transaction.objectStore('downloadTasks');
+         const index = store.index('status');
+         const request = index.getAll('pending');
+         
+         request.onsuccess = async (event) => {
+             const tasks = event.target.result;
+             
+             for (const task of tasks) {
+                 if (!this.isOnline()) {
+                     this.isProcessingQueue = false;
+                     return;
+                 }
+                 
+                 try {
+                     const result = await this.downloadNovel(task.novelId);
+                     
+                     // 更新任务状态
+                     const updateTransaction = this.db.transaction(['downloadTasks'], 'readwrite');
+                     const updateStore = updateTransaction.objectStore('downloadTasks');
+                     
+                     if (result.success) {
+                         // 成功，删除任务
+                         updateStore.delete(task.id);
+                     } else {
+                         // 失败，增加重试次数
+                         task.retries++;
+                         task.lastError = result.message;
+                         
+                         if (task.retries >= 3) {
+                             task.status = 'failed';
+                         }
+                         
+                         updateStore.put(task);
+                     }
+                 } catch (error) {
+                     console.error('处理下载队列任务失败:', error);
+                 }
+             }
+             
+             this.isProcessingQueue = false;
+         };
+         
+         request.onerror = (event) => {
+             console.error('获取下载队列失败:', event.target.error);
+             this.isProcessingQueue = false;
+         };
+     }
+     
+     // 获取缓存使用情况
+     async getStorageUsage() {
+         if (!this.db) await this.initDatabase();
+         
+         const novels = await this.getAllNovels();
+         
+         let totalSize = 0;
+         let novelCount = novels.length;
+         
+         for (const novel of novels) {
+             totalSize += novel.size || 0;
+         }
+         
+         return {
+             totalSize,
+             sizeLimit: this.storageLimit,
+             usedPercentage: Math.round((totalSize / this.storageLimit) * 100),
+             novelCount
+         };
+     }
+     
+     // 估算内容大小
+     estimateSize(novel) {
+         let size = 0;
+         
+         // 标题和作者
+         size += (novel.title?.length || 0) * 2;
+         size += (novel.author?.length || 0) * 2;
+         
+         // 内容
+         size += (novel.content?.length || 0) * 2;
+         
+         // 摘要和标签
+         size += (novel.summary?.length || 0) * 2;
+         size += JSON.stringify(novel.tags || []).length;
+         
+         // 其他元数据
+         size += JSON.stringify(novel).length;
+         
+         return size;
+     }
+     
+     // 检查存储空间并清理过期数据
+     async checkAndCleanStorage(newNovel = null) {
+         const usage = await this.getStorageUsage();
+         const newSize = newNovel ? this.estimateSize(newNovel) : 0;
+         
+         // 如果添加新内容后超过限制，清理旧数据
+         if (usage.totalSize + newSize > this.storageLimit) {
+             const novels = await this.getAllNovels();
+             
+             // 按最后访问时间排序
+             novels.sort((a, b) => a.timestamp - b.timestamp);
+             
+             let freedSpace = 0;
+             const needToFree = usage.totalSize + newSize - this.storageLimit + 1024 * 1024; // 额外释放1MB空间
+             
+             for (const novel of novels) {
+                 await this.deleteNovel(novel.id);
+                 freedSpace += novel.size || 0;
+                 
+                 if (freedSpace > needToFree) break;
+             }
+         }
+     }
+     
+     // 清除全部离线数据
+     async clearAllOfflineData() {
+         if (!this.db) await this.initDatabase();
+         
+         return new Promise((resolve, reject) => {
+             const transaction = this.db.transaction(['novels', 'downloadTasks'], 'readwrite');
+             
+             // 清除小说
+             const novelStore = transaction.objectStore('novels');
+             const novelClear = novelStore.clear();
+             
+             // 清除下载任务
+             const taskStore = transaction.objectStore('downloadTasks');
+             const taskClear = taskStore.clear();
+             
+             transaction.oncomplete = () => {
+                 resolve(true);
+             };
+             
+             transaction.onerror = (event) => {
+                 console.error('清除离线数据失败:', event.target.error);
+                 reject(event.target.error);
+             };
+         });
+     }
+     
+     // 设置存储限制
+     setStorageLimit(limitInMB) {
+         const limit = Math.max(10, Math.min(500, limitInMB)) * 1024 * 1024; // 限制在10-500MB之间
+         this.storageLimit = limit;
+         localStorage.setItem('offline_storage_limit', limit.toString());
+     }
+     
+     // 检查小说是否离线可用
+     async isNovelAvailableOffline(novelId) {
+         const novel = await this.getNovel(novelId);
+         return !!novel;
+     }
+     
+     // 注册Toast通知函数
+     registerToastFunction(toastFn) {
+         this.showToast = toastFn;
+     }
+ }
+ 
+ // 导出为全局变量
+ window.OfflineReaderManager = OfflineReaderManager; 
```

---

### 3.2 修改阅读器以支持离线功能

---

```diff
          this.settings = this.loadSettings();
          this.readingProgress = this.loadProgress();
+         this.isOffline = false;
+         
+         // 初始化离线阅读管理器
+         this.offlineManager = window.offlineManager || new OfflineReaderManager();
          
          this.initializeElements();
              novelInfo: document.getElementById('novelInfo'),
              novelContent: document.getElementById('novelContent'),
-             progressBar: document.getElementById('progressBar')
-         };
+             progressBar: document.getElementById('progressBar'),
+             // 离线状态指示器
+             offlineStatus: null,
+             // 离线下载按钮
+             offlineDownloadBtn: null
+         };
+         
+         // 添加离线状态指示器
+         this.elements.offlineStatus = document.createElement('div');
+         this.elements.offlineStatus.className = 'offline-status-indicator hidden';
+         document.querySelector('.reader-container').prepend(this.elements.offlineStatus);
+         
+         // 在小说信息卡片添加离线下载按钮
+         const novelActions = document.querySelector('.novel-actions');
+         if (novelActions) {
+             this.elements.offlineDownloadBtn = document.createElement('button');
+             this.elements.offlineDownloadBtn.className = 'offline-download-btn';
+             this.elements.offlineDownloadBtn.innerHTML = `
+                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
+                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
+                 </svg>
+                 保存离线阅读
+             `;
+             novelActions.appendChild(this.elements.offlineDownloadBtn);
+         }
      }
  
              }, 300); // 防抖处理
          });
+ 
+         // 离线下载按钮点击事件
+         if (this.elements.offlineDownloadBtn) {
+             this.elements.offlineDownloadBtn.addEventListener('click', async () => {
+                 this.downloadForOfflineReading();
+             });
+         }
+         
+         // 网络状态变化事件
+         window.addEventListener('online', () => {
+             this.showToast('网络已连接', 'info');
+         });
+         
+         window.addEventListener('offline', () => {
+             this.showToast('网络已断开，切换到离线模式', 'warning');
+         });
      }
  
      async loadNovel() {
          try {
+             // 检查是否有离线版本
+             const offlineNovel = await this.offlineManager.getNovel(this.novelId);
+             
+             if (offlineNovel) {
+                 console.log('找到离线缓存版本，使用离线数据');
+                 this.isOffline = true;
+                 this.displayNovel(offlineNovel);
+                 this.updateOfflineStatus(true);
+                 return;
+             }
+             
+             // 没有离线版本，检查网络
+             if (!navigator.onLine) {
+                 console.log('网络已断开，无法加载小说');
+                 this.showError('网络已断开，无法加载小说内容。请先将小说保存到离线库再阅读。');
+                 this.updateOfflineStatus(false, true);
+                 return;
+             }
+             
              // 尝试从API加载
-             const response = await fetch('/api/novels');
+             const response = await fetch('/api/novels/' + this.novelId);
              if (response.ok) {
                  const data = await response.json();
-                 const novel = data.novels.find(n => n.id.toString() === this.novelId);
- 
-                 if (novel) {
-                     this.displayNovel(novel);
+                 
+                 if (data.success && data.data) {
+                     this.isOffline = false;
+                     this.displayNovel(data.data);
+                     this.updateOfflineStatus(false);
                      return;
                  }
              // 如果没有找到，显示示例内容
              this.displaySampleNovel();
+             this.updateOfflineStatus(false);
  
          } catch (error) {
              console.error('加载小说失败:', error);
+             
+             // 网络错误时，尝试切换到离线模式
+             if (!navigator.onLine) {
+                 const offlineNovel = await this.offlineManager.getNovel(this.novelId);
+                 if (offlineNovel) {
+                     this.isOffline = true;
+                     this.displayNovel(offlineNovel);
+                     this.updateOfflineStatus(true);
+                     return;
+                 }
+             }
+             
              this.displaySampleNovel();
+             this.updateOfflineStatus(false);
          }
      }
          }, 3000);
      }
+     
+     // 更新离线状态指示器
+     updateOfflineStatus(isOffline, isOfflineNeeded = false) {
+         // 更新状态指示器
+         if (this.elements.offlineStatus) {
+             if (isOffline) {
+                 this.elements.offlineStatus.innerHTML = `
+                     <span class="offline-badge">
+                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
+                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
+                         </svg>
+                         离线阅读中
+                     </span>
+                 `;
+                 this.elements.offlineStatus.classList.remove('hidden');
+             } else if (isOfflineNeeded) {
+                 this.elements.offlineStatus.innerHTML = `
+                     <span class="offline-needed-badge">
+                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
+                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
+                         </svg>
+                         需要离线保存
+                     </span>
+                 `;
+                 this.elements.offlineStatus.classList.remove('hidden');
+             } else {
+                 this.elements.offlineStatus.classList.add('hidden');
+             }
+         }
+         
+         // 更新离线下载按钮状态
+         if (this.elements.offlineDownloadBtn) {
+             if (isOffline) {
+                 this.elements.offlineDownloadBtn.innerHTML = `
+                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
+                         <path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z" />
+                     </svg>
+                     已保存离线
+                 `;
+                 this.elements.offlineDownloadBtn.classList.add('saved');
+             } else {
+                 this.elements.offlineDownloadBtn.innerHTML = `
+                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
+                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
+                     </svg>
+                     保存离线阅读
+                 `;
+                 this.elements.offlineDownloadBtn.classList.remove('saved');
+             }
+         }
+     }
+     
+     // 下载小说供离线阅读
+     async downloadForOfflineReading() {
+         if (!this.novelId) {
+             this.showToast('无效的小说ID', 'error');
+             return;
+         }
+         
+         try {
+             this.showToast('正在保存小说到离线库...', 'info');
+             
+             const result = await this.offlineManager.downloadNovel(this.novelId);
+             
+             if (result.success) {
+                 this.showToast(result.message, 'success');
+                 this.updateOfflineStatus(true);
+             } else {
+                 this.showToast(result.message, 'warning');
+             }
+         } catch (error) {
+             console.error('保存离线阅读失败:', error);
+             this.showToast('保存失败: ' + (error.message || '未知错误'), 'error');
+         }
+     }
  }
  
```

---

### 3.3 添加离线阅读管理页面

---

Cancelled

---



---

_**User**_

请继续！请分段编辑输出，避免

---

_**Assistant**_



---

现在我将继续开发离线阅读功能，创建离线阅读管理页面和完善相关功能。

---

Cancelled

---



---

